<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.thoughtworks.ketsu.infrastructure.mybatis.mappers.OrderMapper">
    <select id="findById" resultMap="records.order">
        SELECT
        O.id AS order_id, O.user_id AS user_id, O.time as order_time, U.email AS user_email,
        I.product_id AS product_id, I.product_name AS product_name, I.owner_id AS owner_id, I.owner_email AS owner_email, I.price_id AS price_id, I.price AS price, I.quantity AS quantity
        FROM orders O LEFT JOIN
        ((SELECT
        OI.order_id AS order_id, OI.quantity AS quantity, P.id AS product_id, P.name AS product_name, U.id AS owner_id, U.email as owner_email, PR.id AS price_id, PR.price AS price
        FROM (prices pr, users u) right join (products p, orderitems oi) on pr.id = oi.price_id and u.id = p.user_id) AS I, USERS U)
        ON I.order_id = O.id WHERE O.id = #{id}
    </select>
</mapper>